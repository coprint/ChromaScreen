## DO NOT EDIT THIS FILE, IT IS A TEMPLATE. THAT YOU NEED TO COPY
# Prusa MK3s Klipper Config

# The first thing you'll need to do is go through this file and comment out / uncomment
# the files and/or settings you need.

# You'll be able to print just fine with this config as it is, but it is recommended
# that you follow these steps to properly calibrate your printer:

# 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
# 1) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
# 2) Skew Correction: https://www.klipper3d.org/skew_correction.html
# 3) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html

# Read more about klipper here: https://www.klipper3d.org/Overview.html

### UI
[include chroma_head.cfg]
[include driver.cfg]
[include bed_mesh.cfg]
[include input_shaper.cfg]
[include cp_macro.cfg]
#[include ecm_1.cfg]
#[include ecm_2.cfg]
#[include ecm_3.cfg]
#[include ecm_4.cfg]

[mcu]
serial: /dev/serial0 # If you are using internal RPI serial port
# serial: /dev/ttyACM0 # If you are using RPI via USB connection to printer
restart_method: command

# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.

[stepper_x]
step_pin: PC0
dir_pin: !PL0
enable_pin: !PA7
microsteps: 16
rotation_distance: 32
endstop_pin: tmc2130_stepper_x:virtual_endstop
position_endstop: 0
position_max: 255
homing_speed: 50
homing_retract_dist: 0

[stepper_y]
step_pin: PC1
dir_pin: PL1
enable_pin: !PA6
microsteps: 16
rotation_distance: 32
endstop_pin: tmc2130_stepper_y:virtual_endstop
position_endstop: -4
position_max: 212.5
position_min: -4
homing_speed: 50
homing_retract_dist: 0

[stepper_z]
step_pin: PC2
dir_pin: !PL2
enable_pin: !PA5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 215
position_min: -2
homing_speed: 13.333


# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.


[tmc2130 stepper_x]
cs_pin: PG0
interpolate: True
stealthchop_threshold: 0
run_current: .281738
hold_current: .281738
sense_resistor: 0.220
diag1_pin: !PK2
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 2
driver_PWM_AMPL: 230
driver_PWM_AUTOSCALE: True
driver_SGT: 3

[tmc2130 stepper_y]
cs_pin: PG2
interpolate: True
stealthchop_threshold: 0
run_current: .281738
hold_current: .281738
sense_resistor: 0.220
diag1_pin: !PK7
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 2
driver_PWM_AMPL: 230
driver_PWM_AUTOSCALE: True
driver_SGT: 3

[tmc2130 stepper_z]
cs_pin: PK5
run_current: .53033
hold_current: .53033
sense_resistor: 0.220
diag1_pin: !PK6
interpolate: True
driver_IHOLDDELAY: 8
driver_TPOWERDOWN: 0
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 1
driver_HSTRT: 5
driver_PWM_FREQ: 2
driver_PWM_GRAD: 4
driver_PWM_AMPL: 200
driver_PWM_AUTOSCALE: True
driver_SGT: 4

# [tmc2130 extruder]
# cs_pin: PK4
# interpolate: True
# run_current: .513757
# hold_current: .513757
# sense_resistor: 0.220
# diag1_pin: !PK3
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 0
# driver_TBL: 2
# driver_TOFF: 3
# driver_HEND: 1
# driver_HSTRT: 5
# driver_PWM_FREQ: 2
# driver_PWM_GRAD: 4
# driver_PWM_AMPL: 240
# driver_PWM_AUTOSCALE: True
# driver_SGT: 3

# [extruder]
# step_pin: PC3
# dir_pin: PL6
# enable_pin: !PA4
# microsteps: 16

# ### EXTRUSION

# # Extruder
# [include klipper-prusa-mk3s/extruders/prusa.cfg]
# # [include klipper-prusa-mk3s/extruders/bmg.cfg]

# # Hotend
# [include klipper-prusa-mk3s/hotends/v6.cfg]
# # [include klipper-prusa-mk3s/hotends/dragon-standard-flow.cfg]
# # [include klipper-prusa-mk3s/hotends/rapido.cfg]

# [extruder]
# # To tune Pressure Advance see https://www.klipper3d.org/Pressure_Advance.html
# # default is already set based on hotend, but you can further improve prints by calibrating it to your nozzle and material
# # pressure_advance: 0.05
# nozzle_diameter: 0.4 # Remember to change this if you change nozzle diameter.
# pid_Kp: 23.862
# pid_Ki: 1.020
# pid_Kd: 139.595

## copy this from your current setting on Prusa, but make it absolute (removing -)
# [probe]
# z_offset = 0.685

## For faster printing enable
# [printer]
# max_accel: 2000
# max_accel_to_decel: 2000
# max_z_velocity: 20
# max_z_accel: 300

## For stealth mode enable

# [tmc2130 stepper_x]
# interpolate: True
# stealthchop_threshold: 80
# [tmc2130 stepper_y]
# interpolate: True
# stealthchop_threshold: 80
# [tmc2130 stepper_z]
# interpolate: True
# stealthchop_threshold: 80

## Custom bed mest probes
## Prusa has 3x3 or 7x7, you can do any variation you want
# [bed_mesh]
# probe_count: 4,4

# Linear correction
# # 

# FIRST RUN: 
# Execute these sequentially in the console, let PID tuning finish before saving
# PID_CALIBRATE HEATER=extruder TARGET=170
# SAVE_CONFIG
# PID_CALIBRATE HEATER=heater_bed TARGET=60
# SAVE_CONFIG

# You can also skip the above setting for stock Prusa and use
# [extruder]
# control: pid
# min_temp: 0
# max_temp: 305
# min_extrude_temp: 170


### The end, on the end the printer will store it's tuning data, so do not edit it.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 5